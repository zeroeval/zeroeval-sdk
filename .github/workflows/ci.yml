name: ğŸš€ SDK CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  quality:
    name: ğŸ” Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: ğŸ”§ Set up Python
        run: uv python install 3.12

      - name: ğŸ“¦ Install dependencies
        run: uv sync --group dev

      - name: ğŸ¨ Check Formatting
        run: |
          echo "::group::ğŸ¨ Ruff Formatting"
          uv run ruff format --check --diff .
          echo "::endgroup::"

      - name: ğŸ” Run Linting
        run: |
          echo "::group::ğŸ” Ruff Linting"
          uv run ruff check . --output-format=github
          echo "::endgroup::"

      - name: ğŸ”¬ Type Checking
        run: |
          echo "::group::ğŸ”¬ MyPy Type Checking"
          uv run mypy src/zeroeval --show-error-codes
          echo "::endgroup::"

      - name: âœ… Quality Summary
        if: success()
        run: |
          echo "::notice::âœ… All code quality checks passed!"
          echo "- Formatting: PASSED"
          echo "- Linting: PASSED"
          echo "- Type checking: PASSED"

  test:
    name: ğŸ§ª Test Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12", "3.13"]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: ğŸ”§ Set up Python ${{ matrix.python-version }}
        run: uv python install ${{ matrix.python-version }}

      - name: ğŸ“¦ Install dependencies
        run: uv sync --group dev

      - name: ğŸ§ª Run Core Tests
        run: |
          echo "::group::ğŸ§ª Core Tests"
          uv run pytest tests/core/ -v --tb=short
          echo "::endgroup::"

      - name: âš¡ Run Performance Tests
        run: |
          echo "::group::âš¡ Performance Tests"
          uv run pytest tests/performance/ --runperformance -v --tb=short
          echo "::endgroup::"

      - name: ğŸ“Š Test Summary
        if: success()
        run: |
          echo "::notice::âœ… All tests passed on Python ${{ matrix.python-version }}!"
          echo "- Core tests: PASSED"
          echo "- Performance tests: PASSED"

  test-matrix:
    name: ğŸ¯ Multi-Python Matrix
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: ğŸ”§ Set up Python versions
        run: uv python install 3.9 3.10 3.11 3.12 3.13

      - name: ğŸ“¦ Install dependencies
        run: uv sync --group dev

      - name: ğŸ¯ Run Tox Matrix
        run: |
          echo "::group::ğŸ¯ Tox Multi-Python Testing"
          uv run tox --parallel auto
          echo "::endgroup::"

      - name: ğŸ“ˆ Matrix Summary
        if: success()
        run: |
          echo "::notice::âœ… Multi-Python matrix testing completed!"
          echo "- Tested across Python 3.9-3.13"
          echo "- Core + Performance tests: PASSED"

  all-checks:
    name: âœ… All Checks
    runs-on: ubuntu-latest
    needs: [quality, test, test-matrix]
    if: always()

    steps:
      - name: ğŸ‰ Success Summary
        if: ${{ needs.quality.result == 'success' && needs.test.result == 'success' && needs.test-matrix.result == 'success' }}
        run: |
          echo "::notice::ğŸ‰ All CI checks passed successfully!"
          echo "âœ… Code Quality: PASSED"
          echo "âœ… Individual Tests: PASSED"
          echo "âœ… Matrix Tests: PASSED"
          echo ""
          echo "ğŸš€ Ready to merge!"

      - name: âŒ Failure Summary
        if: ${{ needs.quality.result == 'failure' || needs.test.result == 'failure' || needs.test-matrix.result == 'failure' }}
        run: |
          echo "::error::âŒ Some CI checks failed"
          echo "ğŸ” Code Quality: ${{ needs.quality.result }}"
          echo "ğŸ§ª Individual Tests: ${{ needs.test.result }}"
          echo "ğŸ¯ Matrix Tests: ${{ needs.test-matrix.result }}"
          echo ""
          echo "Please fix the failing checks before merging."
          exit 1
